<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - إدارة الحلقات</title>
    <link rel="icon" type="image/png" href="anime4u.png">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body { font-family: 'Cairo', Arial, sans-serif; }
        .input, select { outline: none; }
        .card { box-shadow: 0 6px 18px rgba(0,0,0,.06); }
        .server-row { border: 1px dashed #e5e7eb; border-radius: .75rem; padding: .75rem; }
        
        /* تحسينات التجاوب المتقدمة */
        @media (max-width: 640px) {
            .mobile-stack { flex-direction: column; align-items: stretch; }
            .mobile-full { width: 100%; }
            .mobile-text-sm { font-size: 0.875rem; }
            .mobile-p-3 { padding: 0.75rem; }
            .mobile-gap-2 { gap: 0.5rem; }
            .mobile-icon-sm { font-size: 0.875rem; }
            .mobile-btn-compact { padding: 0.5rem 0.75rem; font-size: 0.75rem; }
        }
        
        @media (max-width: 768px) {
            .tablet-stack { flex-direction: column; align-items: stretch; }
            .tablet-full { width: 100%; }
            .tablet-text-base { font-size: 1rem; }
            .tablet-icon-base { font-size: 1rem; }
        }
        
        @media (min-width: 1024px) {
            .desktop-icon-lg { font-size: 1.25rem; }
            .desktop-btn-lg { padding: 0.875rem 1.5rem; font-size: 1.125rem; }
        }
        
        /* تحسين عرض الجدول على الشاشات الصغيرة */
        .responsive-table { overflow-x: auto; }
        .responsive-table table { min-width: 600px; }
        
        /* تحسين البطاقات على الشاشات المختلفة */
        .cards-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(140px, 1fr));
            gap: 1rem;
        }
        
        @media (max-width: 640px) {
            .cards-grid { 
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
                gap: 0.75rem;
            }
        }
        
        @media (min-width: 1024px) {
            .cards-grid { 
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
                gap: 1.25rem;
            }
        }

        /* تحسينات الأيقونات والأزرار */
        .icon-responsive {
            transition: all 0.3s ease;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }

        .icon-responsive:hover {
            transform: scale(1.1);
            color: #3b82f6;
        }

        .btn-responsive {
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-responsive::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s;
        }

        .btn-responsive:hover::before {
            left: 100%;
        }

        .btn-responsive:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }

        /* تعريف الألوان المفقودة */
        .gradient-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .gradient-success {
            background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
        }

        .gradient-danger {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }

        .shadow-responsive {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @media (max-width: 640px) {
            .shadow-responsive {
                box-shadow: 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            }
        }

        /* تحسينات خاصة بالشاشات الصغيرة */
        @media (max-width: 480px) {
            .mobile-icon-xs { font-size: 0.75rem; }
            .mobile-btn-xs { padding: 0.375rem 0.5rem; font-size: 0.7rem; }
            .mobile-text-xs { font-size: 0.75rem; }
        }

        /* تحسينات خاصة بالشاشات الكبيرة */
        @media (min-width: 1280px) {
            .desktop-icon-xl { font-size: 1.5rem; }
            .desktop-btn-xl { padding: 1rem 2rem; font-size: 1.25rem; }
        }

        /* تحسينات التخطيط */
        .layout-responsive {
            display: grid;
            gap: 1rem;
        }

        @media (min-width: 768px) {
            .layout-responsive {
                grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            }
        }

        /* تحسينات الألوان والتدرجات */
        .gradient-primary {
            background: linear-gradient(135deg, #3b82f6, #8b5cf6);
        }

        .gradient-secondary {
            background: linear-gradient(135deg, #8b5cf6, #ec4899);
        }

        .gradient-success {
            background: linear-gradient(135deg, #10b981, #059669);
        }

        .gradient-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
        }

        /* تحسينات الظلال */
        .shadow-responsive {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
        }

        @media (min-width: 768px) {
            .shadow-responsive {
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            }
        }

        @media (min-width: 1024px) {
            .shadow-responsive {
                box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            }
        }
    </style>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { 500: '#3b82f6', 600: '#2563eb' },
                        secondary: { 500: '#8b5cf6' }
                    }
                }
            }
        }
    </script>
</head>
<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen">
    <header class="bg-white shadow-responsive sticky top-0 z-40 backdrop-blur-sm bg-white/90 border-b border-gray-100">
        <div class="max-w-5xl mx-auto px-3 sm:px-4 py-3 sm:py-4 flex items-center justify-between flex-wrap gap-2">
            <a href="index.html" class="px-3 sm:px-4 py-2 gradient-primary text-white rounded-xl font-semibold text-sm sm:text-base whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300">
                <i class="fas fa-home ml-1 sm:ml-2 icon-responsive"></i>
                <span class="hidden sm:inline">الرئيسية</span>
                <span class="sm:hidden">الرئيسية</span>
            </a>
            <div class="flex items-center gap-2 flex-1 justify-center">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-primary-500 to-secondary-500 rounded-full flex items-center justify-center shadow-responsive">
                    <i class="fas fa-cog text-white text-sm sm:text-base icon-responsive"></i>
                </div>
                <h1 class="text-base sm:text-lg font-bold text-gray-800 text-center">لوحة التحكم - إضافة حلقات يدوياً</h1>
            </div>
            <div class="flex items-center gap-2">
                <button class="w-8 h-8 sm:w-10 sm:h-10 bg-gray-100 hover:bg-gray-200 text-gray-600 rounded-full flex items-center justify-center transition-all duration-300 icon-responsive">
                    <i class="fas fa-bell text-sm sm:text-base"></i>
                </button>
                <button class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-green-500 to-emerald-500 text-white rounded-full flex items-center justify-center transition-all duration-300 icon-responsive">
                    <i class="fas fa-user-shield text-sm sm:text-base"></i>
                </button>
            </div>
        </div>
    </header>

    <main class="max-w-5xl mx-auto px-3 sm:px-4 py-4 sm:py-6 space-y-4 sm:space-y-6">
        <div class="bg-white rounded-2xl p-3 sm:p-5 card shadow-responsive hover:shadow-lg transition-all duration-300 border border-gray-50">
            <div class="flex items-center gap-3 mb-4 sm:mb-5">
                <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-blue-500 to-purple-500 rounded-xl flex items-center justify-center shadow-responsive">
                    <i class="fas fa-play-circle text-white text-sm sm:text-base icon-responsive"></i>
                </div>
                <h2 class="text-lg sm:text-xl font-bold text-gray-800">بيانات الحلقة</h2>
            </div>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-3 sm:gap-4">
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-tv text-primary-500 text-sm icon-responsive"></i>
                        اسم الأنمي
                    </label>
                    <input id="animeName" list="animeList" class="input w-full border-2 border-gray-200 hover:border-primary-300 focus:border-primary-500 rounded-xl px-4 py-3 text-sm sm:text-base transition-all duration-300 shadow-responsive" placeholder="اختر أو اكتب اسم الأنمي">
                    <datalist id="animeList"></datalist>
                    <div class="text-xs text-gray-500 mt-1 flex items-center gap-1">
                        <i class="fas fa-info-circle text-primary-400"></i>
                        اختر من القائمة المنسدلة لضمان مطابقة الاسم تماماً
                    </div>
                </div>
                <div class="space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-hashtag text-secondary-500 text-sm icon-responsive"></i>
                        رقم الحلقة
                    </label>
                    <input id="episodeNumber" class="input w-full border-2 border-gray-200 hover:border-secondary-300 focus:border-secondary-500 rounded-xl px-4 py-3 text-sm sm:text-base transition-all duration-300 shadow-responsive" placeholder="مثال: الحلقة 1">
                </div>
                <div class="lg:col-span-2 space-y-2">
                    <label class="block text-sm font-semibold text-gray-700 mb-2 flex items-center gap-2">
                        <i class="fas fa-tag text-accent-500 text-sm icon-responsive"></i>
                        عنوان الحلقة (اختياري)
                    </label>
                    <input id="episodeTitle" class="input w-full border-2 border-gray-200 hover:border-accent-300 focus:border-accent-500 rounded-xl px-4 py-3 text-sm sm:text-base transition-all duration-300 shadow-responsive" placeholder="عنوان الحلقة">
                </div>
            </div>

            <div class="mt-6">
                <details class="bg-gradient-to-r from-blue-50 to-indigo-50 rounded-xl p-4 sm:p-5 border border-blue-100 shadow-responsive hover:shadow-lg transition-all duration-300">
                    <summary class="cursor-pointer font-semibold text-gray-800 text-sm sm:text-base flex items-center gap-2 hover:text-blue-600 transition-colors duration-200">
                        <i class="fas fa-code text-blue-500 text-lg icon-responsive"></i>
                        استيراد حلقات لهذا الأنمي عبر JSON
                    </summary>
                    <div class="mt-4 space-y-3">
                        <div class="relative">
                            <textarea id="animeJsonInput" class="w-full border-2 border-blue-200 hover:border-blue-300 focus:border-blue-500 rounded-xl p-3 sm:p-4 text-xs sm:text-sm transition-all duration-300 shadow-responsive font-mono" rows="4" placeholder='مثال:
[
  {"episode_number":"الحلقة 2","title":"عنوان","watch_servers":[{"name":"megamax","url":"https://..."}]}
]'></textarea>
                            <div class="absolute top-2 left-2 w-2 h-2 bg-blue-400 rounded-full"></div>
                        </div>
                        <div class="text-xs text-blue-600 bg-blue-50 p-2 rounded-lg border border-blue-200">
                            <i class="fas fa-lightbulb text-blue-500 ml-1"></i>
                            يقبل أيضاً شكلاً كاملاً: {"اسم الأنمي": [{...},{...}]} أو {"name":"اسم","episodes":[...]}
                        </div>
                        <div class="flex flex-col sm:flex-row items-start sm:items-center gap-3">
                            <button id="importAnimeJsonBtn" class="px-4 py-2.5 gradient-primary text-white rounded-xl text-xs sm:text-sm whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300">
                                <i class="fas fa-file-import ml-2 icon-responsive"></i>استيراد لهذا الأنمي
                            </button>
                            <label class="inline-flex items-center text-xs sm:text-sm text-blue-700 bg-blue-100 px-3 py-2 rounded-lg cursor-pointer hover:bg-blue-200 transition-colors duration-200">
                                <input id="replaceMode" type="checkbox" class="ml-2 text-blue-600">
                                استبدال الحلقات الحالية بدلاً من الدمج
                            </label>
                        </div>
                    </div>
                </details>
            </div>

            <div class="mt-6 sm:mt-8">
                <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3 mb-4">
                    <div class="flex items-center gap-3">
                        <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-green-500 to-emerald-500 rounded-xl flex items-center justify-center shadow-responsive">
                            <i class="fas fa-server text-white text-sm sm:text-base icon-responsive"></i>
                        </div>
                        <h3 class="font-semibold text-gray-800 text-sm sm:text-base">السيرفرات</h3>
                    </div>
                    <div class="flex items-center gap-2 flex-wrap">
                        <button id="loadExistingBtn" class="px-3 py-2.5 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 rounded-xl text-xs sm:text-sm whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                            <i class="fas fa-download text-gray-600 icon-responsive"></i>تحميل الموجودة
                        </button>
                        <button id="addServerBtn" class="px-3 py-2.5 gradient-success text-white rounded-xl text-xs sm:text-sm whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                            <i class="fas fa-plus icon-responsive"></i>إضافة سيرفر
                        </button>
                    </div>
                </div>
                <div id="serversContainer" class="space-y-3 sm:space-y-4"></div>
            </div>

            <div class="mt-6 sm:mt-8 flex flex-col sm:flex-row items-stretch sm:items-center gap-3 sm:gap-4">
                <button id="saveEpisodeBtn" class="px-5 py-3 gradient-success text-white rounded-xl font-semibold text-sm sm:text-base btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-save icon-responsive"></i>حفظ الحلقة
                </button>
                <button id="resetFormBtn" class="px-4 py-3 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 text-gray-700 rounded-xl text-sm sm:text-base btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-2">
                    <i class="fas fa-undo icon-responsive"></i>تفريغ النموذج
                </button>
            </div>
        </div>

        <div class="bg-white rounded-2xl p-3 sm:p-5 card shadow-responsive hover:shadow-lg transition-all duration-300 border border-gray-50">
            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between gap-4 mb-4">
                <div class="flex items-center gap-3">
                    <div class="w-8 h-8 sm:w-10 sm:h-10 bg-gradient-to-r from-purple-500 to-pink-500 rounded-xl flex items-center justify-center shadow-responsive">
                        <i class="fas fa-list-alt text-white text-sm sm:text-base icon-responsive"></i>
                    </div>
                    <h2 class="text-lg sm:text-xl font-bold text-gray-800">الحلقات المضافة يدوياً</h2>
                </div>
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-2 flex-wrap">
                    <label class="flex items-center gap-2 text-xs bg-gradient-to-r from-blue-50 to-indigo-50 border border-blue-200 rounded-lg px-3 py-2 cursor-pointer hover:from-blue-100 hover:to-indigo-100 transition-all duration-200">
                        <input type="checkbox" id="filterAiring" class="text-blue-600">
                        <i class="fas fa-broadcast-tower text-blue-500"></i>
                        فقط الأنميات التي "يعرض الآن"
                    </label>
                    <label class="flex items-center gap-2 text-xs bg-gradient-to-r from-green-50 to-emerald-50 border border-green-200 rounded-lg px-3 py-2 cursor-pointer hover:from-green-100 hover:to-emerald-100 transition-all duration-200">
                        <input type="checkbox" id="validateNames" class="text-green-600" checked>
                        <i class="fas fa-check-circle text-green-500"></i>
                        تجاهل الأسماء غير الموجودة في قاعدة البيانات
                    </label>
                    <button id="exportBtn" class="px-3 py-2 gradient-success text-white rounded-lg text-xs sm:text-sm whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-file-export icon-responsive"></i>تصدير JSON
                    </button>
                    <label class="px-3 py-2 gradient-primary text-white rounded-lg text-xs sm:text-sm cursor-pointer whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-file-import icon-responsive"></i>استيراد JSON (كامل)
                        <input type="file" id="importInput" accept="application/json" class="hidden">
                    </label>
                    <button id="clearAllBtn" class="px-3 py-2 gradient-danger text-white rounded-lg text-xs sm:text-sm whitespace-nowrap btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-trash icon-responsive"></i>حذف الكل
                    </button>
                </div>
            </div>
            <div class="mb-4 flex flex-col sm:flex-row items-stretch sm:items-center justify-between gap-3 sm:gap-4 flex-wrap">
                <div class="flex flex-col sm:flex-row items-stretch sm:items-center gap-3">
                    <div class="relative flex-1">
                        <input id="tableFilter" class="input border-2 border-gray-200 hover:border-primary-300 focus:border-primary-500 rounded-xl px-4 py-2.5 text-xs sm:text-sm flex-1 transition-all duration-300 shadow-responsive" placeholder="فلترة بحسب اسم الأنمي">
                        <i class="fas fa-search absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 text-sm"></i>
                    </div>
                    <select id="pageSizeSelect" class="input border-2 border-gray-200 hover:border-secondary-300 focus:border-secondary-500 rounded-xl px-3 py-2.5 text-xs sm:text-sm transition-all duration-300 shadow-responsive">
                        <option value="25">25</option>
                        <option value="50">50</option>
                        <option value="100" selected>100</option>
                        <option value="200">200</option>
                    </select>
                </div>
                <div class="flex items-center justify-center sm:justify-end gap-2">
                    <button id="prevPage" class="px-3 py-2 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 rounded-xl text-xs sm:text-sm btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-1">
                        <i class="fas fa-chevron-right text-xs icon-responsive"></i>السابق
                    </button>
                    <span id="pageInfo" class="text-xs sm:text-sm text-gray-600 px-3 py-2 bg-gray-50 rounded-lg border border-gray-200">صفحة 1/1</span>
                    <button id="nextPage" class="px-3 py-2 bg-gradient-to-r from-gray-100 to-gray-200 hover:from-gray-200 hover:to-gray-300 rounded-xl text-xs sm:text-sm btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-1">
                        التالي<i class="fas fa-chevron-left text-xs icon-responsive"></i>
                    </button>
                </div>
            </div>
            <div class="responsive-table overflow-x-auto rounded-xl border-2 border-gray-200 shadow-responsive">
                <table class="w-full text-xs sm:text-sm">
                    <thead class="sticky top-0 bg-gradient-to-r from-gray-50 to-gray-100 z-10 shadow-sm">
                        <tr class="text-gray-700">
                            <th class="py-3 px-3 text-right font-semibold border-b-2 border-gray-200">
                                <i class="fas fa-tv text-primary-500 ml-2"></i>الأنمي
                            </th>
                            <th class="py-3 px-3 text-right font-semibold border-b-2 border-gray-200">
                                <i class="fas fa-play-circle text-secondary-500 ml-2"></i>الحلقة
                            </th>
                            <th class="py-3 px-3 text-right font-semibold border-b-2 border-gray-200">
                                <i class="fas fa-server text-green-500 ml-2"></i>السيرفرات
                            </th>
                            <th class="py-3 px-3 text-center font-semibold border-b-2 border-gray-200">
                                <i class="fas fa-link text-blue-500 ml-2"></i>روابط
                            </th>
                            <th class="py-3 px-3 text-center font-semibold border-b-2 border-gray-200">
                                <i class="fas fa-cogs text-purple-500 ml-2"></i>إجراءات
                            </th>
                        </tr>
                    </thead>
                    <tbody id="episodesTable" class="align-top bg-white"></tbody>
                </table>
            </div>
        </div>
    </main>

    <script src="js/all_images.js"></script>
    <script src="js/anime-image-loader.js"></script>
    <script>
        const STORAGE_KEY = 'anime4u_custom_episodes';

        function loadStore(){
            try{ return JSON.parse(localStorage.getItem(STORAGE_KEY) || '{}'); }catch(e){ return {}; }
        }
        function saveStore(data){ localStorage.setItem(STORAGE_KEY, JSON.stringify(data)); }

        function mergeAnimeEpisodes(targetStore, animeName, episodes, replace=false){
            if(!Array.isArray(episodes) || !animeName) return targetStore;
            if(!Array.isArray(targetStore[animeName]) || replace) targetStore[animeName] = [];
            const map = new Map((targetStore[animeName]||[]).map(e=>[e.episode_number,e]));
            episodes.forEach(e=>{ if(e && e.episode_number){ map.set(e.episode_number, e); } });
            targetStore[animeName] = Array.from(map.values()).sort((a,b)=> parseInt(String(a.episode_number||'').replace(/[^0-9]/g,'')) - parseInt(String(b.episode_number||'').replace(/[^0-9]/g,'')));
            return targetStore;
        }

        function addServerRow(name='', url=''){
            const container = document.getElementById('serversContainer');
            const row = document.createElement('div');
            row.className = 'server-row grid grid-cols-1 lg:grid-cols-5 gap-3 sm:gap-4 bg-gradient-to-r from-gray-50 to-white rounded-xl p-4 border-2 border-dashed border-gray-200 hover:border-gray-300 transition-all duration-300 shadow-responsive hover:shadow-lg';
            row.innerHTML = `
                <div class="lg:col-span-2">
                    <label class="block text-xs font-semibold text-gray-600 mb-2 flex items-center gap-1">
                        <i class="fas fa-server text-green-500 text-xs icon-responsive"></i>
                        اسم السيرفر
                    </label>
                    <input class="srv-name input w-full border-2 border-gray-200 hover:border-green-300 focus:border-green-500 rounded-xl px-3 py-2.5 text-sm transition-all duration-300 shadow-responsive" placeholder="مثال: megamax" value="${name}">
                </div>
                <div class="lg:col-span-3">
                    <label class="block text-xs font-semibold text-gray-600 mb-2 flex items-center gap-1">
                        <i class="fas fa-link text-blue-500 text-xs icon-responsive"></i>
                        رابط التضمين (iframe)
                    </label>
                    <input class="srv-url input w-full border-2 border-gray-200 hover:border-blue-300 focus:border-blue-500 rounded-xl px-3 py-2.5 text-sm transition-all duration-300 shadow-responsive" placeholder="https://..." value="${url}">
                </div>
                <div class="lg:col-span-5 flex items-center justify-end">
                    <button class="remove-row px-3 py-2 gradient-danger text-white rounded-xl text-xs sm:text-sm btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center gap-2">
                        <i class="fas fa-times icon-responsive"></i>إزالة
                    </button>
                </div>
            `;
            row.querySelector('.remove-row').addEventListener('click', ()=> row.remove());
            container.appendChild(row);
        }

        function resetForm(){
            document.getElementById('animeName').value='';
            document.getElementById('episodeNumber').value='';
            document.getElementById('episodeTitle').value='';
            document.getElementById('serversContainer').innerHTML='';
            addServerRow();
        }

        let tableState = { filter:'', page:1, pageSize:100 };

        function getFlattenedRows(store){
            const all = [];
            const filter = (tableState.filter||'').trim();
            const keys = Object.keys(store);
            for(let i=0;i<keys.length;i++){
                const anime = keys[i];
                if(filter && !anime.includes(filter)) continue;
                const list = store[anime] || [];
                for(let j=0;j<list.length;j++){
                    const ep = list[j];
                    all.push({ anime, ep, idx:j });
                }
            }
            return all;
        }

        function renderTable(){
            const table = document.getElementById('episodesTable');
            const store = loadStore();
            const flat = getFlattenedRows(store);
            const total = flat.length;
            const pageSize = tableState.pageSize;
            const totalPages = Math.max(1, Math.ceil(total / pageSize));
            if(tableState.page > totalPages) tableState.page = totalPages;
            const start = (tableState.page - 1) * pageSize;
            const end = Math.min(start + pageSize, total);
            const slice = flat.slice(start, end);

            const rows = slice.map(({anime, ep, idx})=>`
                        <tr class="border-b border-gray-100 hover:bg-gray-50 transition-all duration-200">
                            <td class="py-3 px-3 text-xs sm:text-sm">
                                <div class="flex items-center gap-2">
                                    <div class="w-6 h-6 bg-gradient-to-r from-blue-500 to-purple-500 rounded-lg flex items-center justify-center">
                                        <i class="fas fa-tv text-white text-xs"></i>
                                    </div>
                                    <span class="font-medium text-gray-800">${anime}</span>
                                </div>
                            </td>
                            <td class="py-3 px-3">
                                <div class="font-semibold text-xs sm:text-sm text-gray-800">${ep.episode_number || ''}</div>
                                <div class="text-gray-500 text-xs mt-1">${ep.title || ''}</div>
                            </td>
                            <td class="py-3 px-3">
                                ${(ep.watch_servers||[]).map(s=>`<div class="text-gray-700 text-xs bg-gray-100 px-2 py-1 rounded-full inline-block mr-1 mb-1">${s.name}</div>`).join('')}
                            </td>
                            <td class="py-3 px-3 text-center">
                                <div class="flex flex-col sm:flex-row gap-2 justify-center">
                                    <a href="details.html?anime=${encodeURIComponent(anime)}" target="_blank" class="px-3 py-1.5 bg-gradient-to-r from-blue-50 to-indigo-50 text-blue-700 hover:from-blue-100 hover:to-indigo-100 rounded-lg text-xs inline-block text-center btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-1">
                                        <i class="fas fa-info-circle text-xs"></i>التفاصيل
                                    </a>
                                    <a href="watch.html?anime=${encodeURIComponent(anime)}&ep=${encodeURIComponent(ep.episode_number)}" target="_blank" class="px-3 py-1.5 bg-gradient-to-r from-green-50 to-emerald-50 text-green-700 hover:from-green-100 hover:to-emerald-100 rounded-lg text-xs inline-block text-center btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-1">
                                        <i class="fas fa-play text-xs"></i>المشاهدة
                                    </a>
                                </div>
                            </td>
                            <td class="py-3 px-3 text-center">
                                <button data-anime="${anime}" data-index="${idx}" class="delete-btn px-3 py-1.5 gradient-danger text-white rounded-lg text-xs btn-responsive shadow-responsive hover:shadow-lg transition-all duration-300 flex items-center justify-center gap-1 mx-auto">
                                    <i class="fas fa-trash text-xs icon-responsive"></i>حذف
                                </button>
                            </td>
                        </tr>
            `);

            table.innerHTML = rows.join('') || `<tr><td colspan="5" class="py-12 text-center">
                <div class="flex flex-col items-center gap-3 text-gray-400">
                    <div class="w-16 h-16 bg-gradient-to-r from-gray-100 to-gray-200 rounded-full flex items-center justify-center">
                        <i class="fas fa-inbox text-2xl text-gray-300"></i>
                    </div>
                    <div class="text-sm font-medium">لا توجد حلقات بعد</div>
                    <div class="text-xs">ابدأ بإضافة حلقة جديدة من النموذج أعلاه</div>
                </div>
            </td></tr>`;
            const pageInfo = document.getElementById('pageInfo');
            if(pageInfo) pageInfo.textContent = `صفحة ${total ? tableState.page : 0}/${total ? totalPages : 0}`;
            table.querySelectorAll('.delete-btn').forEach(btn=>{
                btn.addEventListener('click', ()=>{
                    const anime = btn.getAttribute('data-anime');
                    const index = parseInt(btn.getAttribute('data-index'));
                    const data = loadStore();
                    if(Array.isArray(data[anime])){
                        data[anime].splice(index,1);
                        if(data[anime].length===0) delete data[anime];
                        saveStore(data);
                        // إعادة عرض الصفحة الحالية بدون تجمد
                        requestAnimationFrame(renderTable);
                        requestAnimationFrame(renderCards);
                    }
                });
            });
        }

        function renderCards(){
            let container = document.getElementById('animeCardsSection');
            if(!container){
                const main = document.querySelector('main');
                const wrapper = document.createElement('div');
                wrapper.id = 'animeCardsSection';
                wrapper.className = 'bg-white rounded-2xl p-3 sm:p-5 card';
                wrapper.innerHTML = `
                    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 sm:gap-3 mb-3">
                        <h2 class="text-lg sm:text-xl font-bold text-gray-800">بطاقات الأنمي (من الحلقات المضافة)</h2>
                        <input id="cardsSearch" class="input border border-gray-300 rounded-lg px-3 py-2 text-xs sm:text-sm" placeholder="بحث عن أنمي...">
                    </div>
                    <div id="animeCardsGrid" class="cards-grid"></div>
                `;
                main.insertBefore(wrapper, main.children[1] || null);
                container = wrapper;
            }
            const grid = document.getElementById('animeCardsGrid');
            const store = loadStore();
            const q = (document.getElementById('cardsSearch')?.value || '').trim();
            const entries = Object.keys(store)
                .filter(name => !q || name.includes(q))
                .map(name=>({ name, count: (store[name]||[]).length }));
            entries.sort((a,b)=> a.name.localeCompare(b.name,'ar'));
            const cards = entries.map(e=>{
                const img = (typeof findBestImage==='function' ? (findBestImage(e.name) || '') : '') || 'anime4u.png';
                return `
                <div class="group relative overflow-hidden rounded-xl border border-gray-200 hover:border-primary-300 transition-all duration-300 hover:shadow-lg cursor-pointer bg-white" onclick="openAnimeModal('${e.name.replace(/'/g, "&#39;")}')" title="${e.name}">
                    <div class="aspect-[2/3] bg-gray-50 relative">
                        <img src="${img}" alt="${e.name}" class="w-full h-full object-cover group-hover:scale-105 transition-transform duration-300" onerror="this.src='anime4u.png'">
                        <div class="absolute top-2 left-2 bg-primary-600 text-white text-xs font-bold px-2 py-1 rounded-full shadow">${e.count} حلقة</div>
                    </div>
                    <div class="p-2 text-right">
                        <div class="font-bold text-gray-800 text-xs sm:text-sm truncate">${e.name}</div>
                    </div>
                </div>`;
            }).join('');
            grid.innerHTML = cards || '<div class="text-gray-500 text-sm">لا توجد بطاقات بعد</div>';
            const cs = document.getElementById('cardsSearch');
            if(cs && !cs._bound){ cs._bound = true; cs.addEventListener('input', ()=> requestAnimationFrame(renderCards)); }
        }

        function ensureModal(){
            if(document.getElementById('animeModal')) return;
            const modal = document.createElement('div');
            modal.id = 'animeModal';
            modal.className = 'fixed inset-0 z-50 hidden';
            modal.innerHTML = `
                <div id="animeModalBackdrop" class="absolute inset-0 bg-black/50 backdrop-blur-sm"></div>
                <div class="absolute inset-0 flex items-center justify-center p-2 sm:p-4">
                    <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto">
                        <div class="flex items-center justify-between p-3 sm:p-4 border-b">
                            <h3 id="animeModalTitle" class="text-base sm:text-lg font-bold text-gray-800"></h3>
                            <button id="animeModalClose" class="w-8 h-8 sm:w-9 sm:h-9 bg-gray-100 hover:bg-gray-200 rounded-full">
                                <i class="fas fa-times text-sm sm:text-base"></i>
                            </button>
                        </div>
                        <div id="animeModalBody" class="p-3 sm:p-4 space-y-2 sm:space-y-3"></div>
                    </div>
                </div>`;
            document.body.appendChild(modal);
            document.getElementById('animeModalBackdrop').addEventListener('click', closeAnimeModal);
            document.getElementById('animeModalClose').addEventListener('click', closeAnimeModal);
            document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') closeAnimeModal(); });
        }

        function openAnimeModal(animeName){
            ensureModal();
            const modal = document.getElementById('animeModal');
            const title = document.getElementById('animeModalTitle');
            const body = document.getElementById('animeModalBody');
            title.innerHTML = `<div class="flex flex-col sm:flex-row sm:items-center gap-2"><span class="text-sm sm:text-base">حلقات: ${animeName}</span><button class="text-xs px-2 py-1 bg-gray-100 hover:bg-gray-200 rounded-lg whitespace-nowrap" onclick="jumpToTableForAnime('${animeName.replace(/'/g, "&#39;")}')">عرض في الجدول</button></div>`;
            const store = loadStore();
            const list = Array.isArray(store[animeName]) ? store[animeName] : [];
            if(list.length === 0){
                body.innerHTML = '<div class="text-center text-gray-600 py-6 sm:py-8 text-sm sm:text-base">لا توجد حلقات مضافة لهذا الأنمي</div>';
            } else {
                const html = list.map(ep=>{
                    const servers = ep.watch_servers || [];
                    return `
                    <div class="border rounded-xl p-2 sm:p-3 hover:bg-gray-50 transition">
                        <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2">
                            <div>
                                <div class="font-bold text-gray-800 text-sm sm:text-base">${ep.episode_number || ''}</div>
                                <div class="text-xs sm:text-sm text-gray-600">${ep.title || ''}</div>
                            </div>
                            <div class="text-xs bg-primary-50 text-primary-700 px-2 py-1 rounded-full self-start">${servers.length} سيرفر</div>
                        </div>
                        ${servers.length? `<div class="mt-2 text-xs sm:text-sm text-gray-700">${servers.map(s=>`<span class="inline-block bg-gray-100 px-2 py-0.5 rounded-full mr-1 mb-1">${s.name}</span>`).join('')}</div>`:''}
                        <div class="mt-3 flex flex-col sm:flex-row items-stretch sm:items-center gap-2">
                            <a href="watch.html?anime=${encodeURIComponent(animeName)}&ep=${encodeURIComponent(ep.episode_number || '')}" target="_blank" class="px-3 py-1.5 bg-primary-600 hover:bg-primary-700 text-white rounded-lg text-xs text-center">فتح المشاهدة</a>
                            <button class="px-3 py-1.5 bg-amber-500 hover:bg-amber-600 text-white rounded-lg text-xs" onclick="editEpisode('${animeName.replace(/'/g, "&#39;")}', '${(ep.episode_number||'').replace(/'/g, "&#39;")}')">تعديل</button>
                            <button class="px-3 py-1.5 bg-red-600 hover:bg-red-700 text-white rounded-lg text-xs" onclick="deleteEpisode('${animeName.replace(/'/g, "&#39;")}', '${(ep.episode_number||'').replace(/'/g, "&#39;")}')">حذف</button>
                        </div>
                    </div>`;
                }).join('');
                body.innerHTML = html;
            }
            modal.classList.remove('hidden');
        }

        function closeAnimeModal(){
            const modal = document.getElementById('animeModal');
            if(modal) modal.classList.add('hidden');
        }
        function jumpToTableForAnime(name){
            const filterInput = document.getElementById('tableFilter');
            if(filterInput){ filterInput.value = name; tableState.filter = name; tableState.page = 1; }
            requestAnimationFrame(()=>{ renderTable(); window.scrollTo({ top: document.querySelector('#episodesTable').getBoundingClientRect().top + window.scrollY - 120, behavior: 'smooth' }); });
            closeAnimeModal();
        }
        function editEpisode(animeName, episodeNumber){
            const store = loadStore();
            const list = Array.isArray(store[animeName]) ? store[animeName] : [];
            const ep = list.find(e => (e.episode_number||'') === episodeNumber);
            if(!ep) { alert('لم يتم العثور على الحلقة'); return; }
            const nameInput = document.getElementById('animeName');
            const numInput = document.getElementById('episodeNumber');
            const titleInput = document.getElementById('episodeTitle');
            const cont = document.getElementById('serversContainer');
            if(nameInput) nameInput.value = animeName;
            if(numInput) numInput.value = ep.episode_number || '';
            if(titleInput) titleInput.value = ep.title || '';
            if(cont){
                cont.innerHTML = '';
                (ep.watch_servers||[]).forEach(s => {
                    const row = document.createElement('div');
                    row.className = 'server-row grid grid-cols-1 lg:grid-cols-5 gap-2 sm:gap-3';
                    row.innerHTML = `
                        <div class="lg:col-span-2">
                            <input class="srv-name input w-full border border-gray-300 rounded-lg px-2 sm:px-3 py-2 text-sm" placeholder="اسم السيرفر" value="${s.name||''}">
                        </div>
                        <div class="lg:col-span-3">
                            <input class="srv-url input w-full border border-gray-300 rounded-lg px-2 sm:px-3 py-2 text-sm" placeholder="رابط التضمين (iframe)" value="${s.url||''}">
                        </div>
                        <div class="lg:col-span-5 flex items-center justify-end">
                            <button class="remove-row px-2 sm:px-3 py-2 bg-gray-100 hover:bg-gray-200 rounded-lg text-xs sm:text-sm">
                                <i class="fas fa-times ml-1"></i>إزالة
                            </button>
                        </div>`;
                    row.querySelector('.remove-row').addEventListener('click', ()=> row.remove());
                    cont.appendChild(row);
                });
                if((ep.watch_servers||[]).length===0){ addServerRow(); }
            }
            closeAnimeModal();
            window.scrollTo({ top: document.querySelector('.card').getBoundingClientRect().top + window.scrollY - 80, behavior: 'smooth' });
        }
        function deleteEpisode(animeName, episodeNumber){
            if(!confirm('تأكيد حذف الحلقة؟')) return;
            const data = loadStore();
            const list = Array.isArray(data[animeName]) ? data[animeName] : [];
            const idx = list.findIndex(e => (e.episode_number||'') === episodeNumber);
            if(idx === -1){ alert('لم يتم العثور على الحلقة'); return; }
            list.splice(idx,1);
            if(list.length===0) delete data[animeName]; else data[animeName]=list;
            saveStore(data);
            requestAnimationFrame(()=>{ renderTable(); renderCards(); openAnimeModal(animeName); });
        }

        function saveEpisode(){
            const anime = document.getElementById('animeName').value.trim();
            const num = document.getElementById('episodeNumber').value.trim();
            const title = document.getElementById('episodeTitle').value.trim();
            if(!anime || !num){ alert('يرجى إدخال اسم الأنمي ورقم الحلقة'); return; }

            const servers = [];
            document.querySelectorAll('#serversContainer .server-row').forEach(row=>{
                const name = row.querySelector('.srv-name').value.trim();
                const url = row.querySelector('.srv-url').value.trim();
                if(name && url){ servers.push({ name, url }); }
            });

            const entry = {
                episode_number: num.startsWith('الحلقة') ? num : `الحلقة ${num}`,
                title,
                watch_servers: servers
            };

            const data = loadStore();
            if(!Array.isArray(data[anime])) data[anime] = [];
            // منع تكرار نفس رقم الحلقة
            const existsIdx = data[anime].findIndex(e=>e.episode_number===entry.episode_number);
            if(existsIdx>-1) data[anime][existsIdx]=entry; else data[anime].push(entry);
            // ترتيب بحسب الرقم إن أمكن
            data[anime].sort((a,b)=> parseInt(a.episode_number.replace(/[^0-9]/g,'')) - parseInt(b.episode_number.replace(/[^0-9]/g,'')) );
            saveStore(data);
            renderTable();
            alert('تم حفظ الحلقة بنجاح');
        }

        async function loadAnimeNames(){
            try{
                // محاولة تحميل من عدة مسارات
                const paths = [
                    'anime_data.json',
                    './anime_data.json',
                    '../anime_data.json',
                    'file:///android_asset/www/anime_data.json',
                    'android_asset/www/anime_data.json',
                    'assets/www/anime_data.json'
                ];
                
                let res = null;
                for (const path of paths) {
                    try {
                        res = await fetch(path, { cache: 'no-cache' });
                        if (res.ok) break;
                    } catch (e) {
                        console.warn('فشل تحميل من:', path);
                    }
                }
                
                if (!res || !res.ok) {
                    console.error('فشل تحميل anime_data.json من جميع المسارات');
                    return;
                }
                
                const data = await res.json();
                const names = Object.values(data)
                    .filter(a=>{
                        const s1 = (a['حالة الأنمي']||'').toString();
                        const s2 = (a['الحالة']||'').toString();
                        return s1.includes('يعرض') || s2.includes('يعرض');
                    })
                    .map(a=>a.name)
                    .filter(Boolean)
                    .sort((a,b)=> a.localeCompare(b,'ar'));
                const unique = Array.from(new Set(names));
                const dl = document.getElementById('animeList');
                dl.innerHTML = unique.map(n=>`<option value="${n}"></option>`).join('');
            }catch(e){ /* silent */ }
        }

        document.addEventListener('DOMContentLoaded', ()=>{
            document.getElementById('addServerBtn').addEventListener('click', ()=> addServerRow());
            document.getElementById('resetFormBtn').addEventListener('click', resetForm);
            document.getElementById('saveEpisodeBtn').addEventListener('click', saveEpisode);
            document.getElementById('clearAllBtn').addEventListener('click', ()=>{ if(confirm('متأكد من حذف جميع الحلقات المضافة يدوياً؟')){ localStorage.removeItem(STORAGE_KEY); renderTable(); }});
            document.getElementById('exportBtn').addEventListener('click', ()=>{
                const data = loadStore();
                const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
                const a = document.createElement('a');
                a.href = URL.createObjectURL(blob);
                a.download = 'custom_episodes.json';
                a.style.display = 'none';
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(a.href);
                alert('تم تصدير الملف بنجاح!');
            });
            document.getElementById('importInput').addEventListener('change', async (e)=>{
                const file = e.target.files && e.target.files[0];
                if(!file) return;
                try{
                    const text = await file.text();
                    const json = JSON.parse(text);
                    if(typeof json === 'object'){
                        // دمج ذكي مع خيارات التحقق والفلترة بحسب "يعرض الآن"
                        const store = loadStore();
                        const airingOnly = document.getElementById('filterAiring').checked;
                        const requireValidNames = document.getElementById('validateNames').checked;

                        let validNames = null;
                        if(requireValidNames || airingOnly){
                            try{
                                // محاولة تحميل من عدة مسارات
                                const paths = [
                                    'anime_data.json',
                                    './anime_data.json',
                                    '../anime_data.json',
                                    'file:///android_asset/www/anime_data.json',
                                    'android_asset/www/anime_data.json',
                                    'assets/www/anime_data.json'
                                ];
                                
                                let res = null;
                                for (const path of paths) {
                                    try {
                                        res = await fetch(path, { cache: 'no-cache' });
                                        if (res.ok) break;
                                    } catch (e) {
                                        console.warn('فشل تحميل من:', path);
                                    }
                                }
                                
                                if (res && res.ok){
                                    const db = await res.json();
                                    validNames = new Map();
                                    Object.values(db).forEach(a=>{
                                        if(!a || !a.name) return;
                                        const isAiring = String(a['حالة الأنمي']||a['الحالة']||'').includes('يعرض');
                                        if(!airingOnly || isAiring){ validNames.set(a.name, true); }
                                    });
                                }
                            }catch(_e){}
                        }

                        const acceptAnime = (name)=>{
                            if(!name) return false;
                            if(!validNames) return true;
                            return validNames.has(name);
                        };

                        if(Array.isArray(json)){
                            const anime = document.getElementById('animeName').value.trim();
                            if(!anime){ alert('املأ حقل اسم الأنمي ثم أعد المحاولة.'); }
                            else if(acceptAnime(anime)) mergeAnimeEpisodes(store, anime, json, false);
                        } else if(json && Array.isArray(json.episodes)){
                            const anime = json.name || document.getElementById('animeName').value.trim();
                            if(!anime){ alert('لم يتم العثور على اسم الأنمي في JSON.'); }
                            else if(acceptAnime(anime)) mergeAnimeEpisodes(store, anime, json.episodes, false);
                        } else {
                            Object.keys(json).forEach(an=>{
                                if(!acceptAnime(an)) return;
                                const eps = json[an];
                                if(Array.isArray(eps)) mergeAnimeEpisodes(store, an, eps, false);
                                else if(eps && Array.isArray(eps.episodes)) mergeAnimeEpisodes(store, an, eps.episodes, false);
                            });
                        }
                        saveStore(store);
                        renderTable();
                        renderCards();
                        alert('تم الاستيراد بنجاح (تم الدمج).');
                    }
                }catch(err){ alert('ملف غير صالح'); }
                e.target.value = '';
            });
            document.getElementById('importAnimeJsonBtn').addEventListener('click', ()=>{
                const anime = document.getElementById('animeName').value.trim();
                if(!anime){ alert('اختر/اكتب اسم الأنمي أولاً'); return; }
                const txt = document.getElementById('animeJsonInput').value.trim();
                if(!txt){ alert('ألصق JSON للحلقات'); return; }
                try{
                    const parsed = JSON.parse(txt);
                    const replace = document.getElementById('replaceMode').checked;
                    const store = loadStore();
                    if(Array.isArray(parsed)){
                        mergeAnimeEpisodes(store, anime, parsed, replace);
                    } else if(parsed && Array.isArray(parsed.episodes)){
                        mergeAnimeEpisodes(store, parsed.name||anime, parsed.episodes, replace);
                    } else {
                        Object.keys(parsed).forEach(an=>{
                            const eps = parsed[an];
                            if(Array.isArray(eps)) mergeAnimeEpisodes(store, an, eps, replace);
                            else if(eps && Array.isArray(eps.episodes)) mergeAnimeEpisodes(store, an, eps.episodes, replace);
                        });
                    }
                    saveStore(store);
                    renderTable();
                    renderCards();
                    alert('تم استيراد الحلقات للأنمي بنجاح');
                }catch(err){ alert('JSON غير صالح'); }
            });
            document.getElementById('loadExistingBtn').addEventListener('click', ()=>{
                const anime = document.getElementById('animeName').value.trim();
                if(!anime){ alert('اختر اسم الأنمي أولاً'); return; }
                const store = loadStore();
                const list = Array.isArray(store[anime]) ? store[anime] : [];
                if(list.length===0){ alert('لا توجد حلقات محفوظة لهذا الأنمي'); return; }
                const last = list[list.length-1];
                document.getElementById('episodeNumber').value = last.episode_number || '';
                document.getElementById('episodeTitle').value = last.title || '';
                const cont = document.getElementById('serversContainer');
                cont.innerHTML='';
                (last.watch_servers||[]).forEach(s=> addServerRow(s.name, s.url));
                if((last.watch_servers||[]).length===0) addServerRow();
            });
            const filterInput = document.getElementById('tableFilter');
            const pageSizeSelect = document.getElementById('pageSizeSelect');
            const prevBtn = document.getElementById('prevPage');
            const nextBtn = document.getElementById('nextPage');
            if(filterInput){ filterInput.addEventListener('input', ()=>{ tableState.filter = filterInput.value.trim(); tableState.page = 1; requestAnimationFrame(renderTable); }); }
            if(pageSizeSelect){ pageSizeSelect.addEventListener('change', ()=>{ tableState.pageSize = parseInt(pageSizeSelect.value)||100; tableState.page = 1; requestAnimationFrame(renderTable); }); }
            if(prevBtn){ prevBtn.addEventListener('click', ()=>{ if(tableState.page>1){ tableState.page--; requestAnimationFrame(renderTable); } }); }
            if(nextBtn){ nextBtn.addEventListener('click', ()=>{ if(tableState.page>1){ tableState.page++; requestAnimationFrame(renderTable); } }); }
            resetForm();
            renderTable();
            renderCards();
            loadAnimeNames();
        });
    </script>
</body>
</html>


